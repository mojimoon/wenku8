name: Scrape and Deploy

on:
  push:
    branches:
      - main
  schedule:
    - cron: '0 0,4,8,12,16,20 * * *'

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Check if already succeeded today
      if: github.event_name == 'schedule'
      id: check_success
      uses: actions/github-script@v7
      with:
        script: |
          const owner = context.repo.owner;
          const repo = context.repo.repo;
          const workflow_id = 'deploy.yml';
          
          // Get today's date in UTC
          const now = new Date();
          const today = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()));
          const todayISO = today.toISOString().split('T')[0];
          
          // Get workflow runs from today
          const runs = await github.rest.actions.listWorkflowRuns({
            owner,
            repo,
            workflow_id,
            per_page: 100,
            status: 'completed',
            created: `>=${todayISO}`
          });
          
          // Check if any run succeeded today (excluding current run)
          for (const run of runs.data.workflow_runs) {
            const runDate = new Date(run.created_at);
            const runDay = new Date(Date.UTC(runDate.getUTCFullYear(), runDate.getUTCMonth(), runDate.getUTCDate()));
            
            if (runDay.getTime() === today.getTime() && 
                run.conclusion === 'success' && 
                run.event === 'schedule' &&
                run.id !== context.runId) {
              console.log(`Found successful scheduled run today: ${run.html_url}`);
              core.setOutput('should_skip', 'true');
              return;
            }
          }
          
          console.log('No successful scheduled run found today, proceeding...');
          core.setOutput('should_skip', 'false');
    
    - name: Checkout code
      if: github.event_name == 'push' || steps.check_success.outputs.should_skip != 'true'
      uses: actions/checkout@v3

    - name: Setup Python
      if: github.event_name == 'push' || steps.check_success.outputs.should_skip != 'true'
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Install dependencies
      if: github.event_name == 'push' || steps.check_success.outputs.should_skip != 'true'
      run: |
        if [ -f "requirements.txt" ]; then
          pip install -r requirements.txt
        fi

    - name: Install Playwright browsers
      if: github.event_name == 'push' || steps.check_success.outputs.should_skip != 'true'
      run: |
        pip install playwright
        python -m playwright install --with-deps

    - name: Setup secrets
      if: github.event_name == 'push' || steps.check_success.outputs.should_skip != 'true'
      run: |
        echo "${{ secrets.WENKU_COOKIES }}" > COOKIE
        echo "STEEL_API_KEY=${{ secrets.STEEL_API_KEY }}" > .env
    
    - name: Run main.py
      if: github.event_name == 'push' || steps.check_success.outputs.should_skip != 'true'
      run: |
        python main.py

    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v4
      if: (github.event_name == 'push' || steps.check_success.outputs.should_skip != 'true') && success()
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./docs
